
@{
    Layout = null;
}

<!DOCTYPE html>

<html>
<head>
    <title>Index</title>
    <meta name="viewport" content="width=device-width" />

    <meta charset="UTF-8">
    @Styles.Render("~/Content/css")
    @Scripts.Render("~/bundles/jquery")
    @Scripts.Render("~/bundles/bootstrap")
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css">

    <script src='https://api.mapbox.com/mapbox-gl-js/v0.51.0/mapbox-gl.js'></script>
    <link href='https://api.mapbox.com/mapbox-gl-js/v0.51.0/mapbox-gl.css' rel='stylesheet' />
    <link rel="stylesheet" href="~/node_modules/leaflet/dist/leaflet.css" />
    <script src="~/node_modules/leaflet/dist/leaflet.js"></script>
    @*<script src="~/node_modules/leaflet/dist/leaflet.js"></script>*@
    <script src="~/node_modules/leaflet.browser.print/dist/leaflet.browser.print.min.js"></script>
    <script src="~/Scripts/plugins/Leaflet.Control.Custom.js"></script>
    <script async defer src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDKZUGWLVGsk1mqeSugFZQbigzOgn_VMkE"></script>
    @*Plugins leaflet-locatecontrol*@
    <link rel="stylesheet" href="~/bower_components/leaflet.locatecontrol/dist/L.Control.Locate.css" />
    <script src="~/bower_components/leaflet.locatecontrol/dist/L.Control.Locate.min.js"></script>

    @*<script src="~/node_modules/leaflet-geosearch/dist/bundle.min.js"></script>*@
    @*<script type="module" src="~/Scripts/plugins/demo.js"></script>*@

    <link rel="stylesheet" href="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.css" />
    <script src="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.js"></script>
    <style>
        body {
            padding: 5px 0 0 0;
        }
        #mapid {
            width: 100%;
            height: 500px;
        }
    </style>
</head>
<body>
    <div id="mapid"></div>
    <script>
        var mymap, tileLayer, maker, printer, locate;
        const initlatlng = [25.044308271193106, 121.52936895061339];
        getMapObject(initlatlng);
        document.getElementById("search").addEventListener("click", function () {
            const queryResult = document.getElementById("queryString");
            if (queryResult.value !== "") {
                geocodeAddress(queryResult.value);
            }
        });
        
        function getMapObject(latlng) {
            const mapOption = {
                attribution: 'Map data &copy; <a href="https://www.openstreetmap.org/">OpenStreetMap</a> contributors, <a href="https://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>, Imagery © <a href="https://www.mapbox.com/">Mapbox</a>',
                maxZoom: 20,
                id: 'mapbox.streets',
                accessToken: 'sk.eyJ1IjoiYW5keXRhMjQiLCJhIjoiY2pwa2lydGg0MDNvYzN4czg0dWppd3FkNiJ9.E6mIiiD1nsXf5XS_-3G5nA',
            };
            const tileLayerStr = 'https://api.tiles.mapbox.com/v4/{id}/{z}/{x}/{y}.png?access_token={accessToken}';
            const getContent = function () {
                const html = '<div class="input-group">' +
                    '            <input id="queryString" type="text" class="form-control input-sm" placeholder="輸入你要找的地址">' +
                    '            <span class="input-group-btn">' +
                    '            <a class="btn btn-default btn-sm" id="search">' +
                    '            <i class="fa fa-search" aria-hidden="true" style="color:red"></i></a>' +
                    '            </span>' +
                    '         </div>';
                return html;
            }
            mymap = L.map('mapid').setView(latlng, 16);
            tileLayer = L.tileLayer(tileLayerStr, mapOption);
            tileLayer.addTo(mymap);
            //L.Control.geocoder().addTo(mymap);
            
            L.control.custom({
                position: 'topright',
                content: getContent(),
                classes: '',
                style: {
                    position: 'absolute',
                    right: '0px',
                    top: '0px',
                    'width': '300px'
        },
                events: {
                    click: function () { }
                }
            }).addTo(mymap);
            maker = L.marker(latlng);
            maker.addTo(mymap);
            // plugin - print
            printer = L.control.browserPrint({
                title: 'Just print me!',
                documentTitle: '這是用 leaflet.browser.print 這個外掛',
                closePopupsOnPrint: false,
                printModes: [
                    L.control.browserPrint.mode.landscape(),
                    L.control.browserPrint.mode.custom("請在畫面上選擇一個區域")
                ]
            });
            printer.addTo(mymap);
            locate = L.control.locate({
                strings: {
                    title: "定位到現在位置"
                }
            });
            locate.addTo(mymap);
        }
        
        /*
         * geocode Services
         *
         * */
        function geocodeAddress(queryValue) {
            const geocoder = new google.maps.Geocoder();
            geocoder.geocode({
                'address': queryValue
            }, function (results, status) {
                if (status === 'OK') {
                    console.log(results[0],"Google 搜尋地理資訊結果");
                    const resultLocation = results[0].geometry.location;
                    const retuLatLng = [resultLocation.lat(), resultLocation.lng()];
                    mymap.setView(retuLatLng, 16);
                    maker = L.marker(retuLatLng);
                    maker.addTo(mymap);
                } else {
                    alert('Geocode was not successful for the following reason: ' + status);
                }
            });

        }
    </script>
</body>

</html>
